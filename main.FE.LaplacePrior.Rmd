---
title: "Hierarchical Poisson Model For Fertility Rate Prediction in Afghanistan"
date: "`r Sys.Date()`"
output: pdf_document
---

# Data preprocessing

## Load, merge and select data

```{r}
library(haven)
library(dplyr)
IMAGEOUT="./paper/pics/"
# wm and hh are original data from UNICEF
# `arrange` to sort the data, won't change the result
wm <- read_sav("data_src/wm.sav")
wm <- wm %>% arrange(HH1, HH2, WM3)
hh <- read_sav("data_src/hh.sav")
hh <- hh %>% arrange(HH1, HH2)
# merge the data base on HH1 and HH2
wm_hh_merged <- merge(wm, hh, by = c("HH1", "HH2"))

variables <- c(
  'CM11',       # Children ever born
  'HH6.y',      # Area
  'HH7.y',      # Province
  'MA3',        # Husband has more wives
  'HH1',        # Cluster number
  'HH2',        # Household number
  'WM3',        # Woman's line number
  'WB6A',       # Highest level of school attended
  'MT2',        # Frequency of listening to the radio
  'MT3',        # Frequency of watching TV
  'MA2',        # Age of husband
  'WAGEM',      # Age at first marriage/union of woman
  'windex5.y',  # Wealth index quintile
  'HHAGE',      # Age of household head
  'helevel',    # Education of household head
  'HHSEX',      # Sex of household head
  'stratum.y',  # Stratum
  'wmweight',   # Woman's sample weight
  'WB4'         # Age of woman
)

# dataframe selected
df_sel <- wm_hh_merged[variables]

# rename the columns
colnames(df_sel) <- c(
  'CEB',        # Children ever born
  'area',       # Area
  'province',   # Province
  'other_wives',# Husband has more wives
  'HH1',        # Cluster number
  'HH2',        # Household number
  'WM3',        # Woman's line number
  'women_edu',  # Highest level of school attended
  'media_radio',# Frequency of listening to the radio
  'media_tv',   # Frequency of watching TV
  'husband_age',# Age of husband
  'women_agem', # Age at first marriage/union of woman
  'windex5',    # Wealth index quintile
  'HH_age',     # Age of household head
  'HH_edu',     # Education of household head
  'HH_sex',     # Sex of household head
  'stratum',    # Stratum
  'wgt',        # Woman's sample weight
  'women_age'   # Age of woman
)

# removes unmarried women
df_sel <- df_sel %>% filter(!is.na(CEB))
# removes 2 rows of missing data in the column `age at first marriage`
df_sel <- df_sel %>% filter(!is.na(women_agem))
```

## Data cleaning

```{r}
# response variables
y <- df_sel$CEB
wgt <- df_sel$wgt

##############################################################
####################FIXED VARIABLES###########################
##############################################################

########################province##############################
province <- df_sel$province


   ##################################################
   #############Descriptive statistics###############
   ##################################################
table(province, useNA="ifany")
# Plot the number of records(women) we have in rural and urban area for each province
library(ggplot2)
province_vs_area <- with(df_sel,table(province, area))
province_vs_area_df <- as.data.frame(province_vs_area)
colnames(province_vs_area_df) <- c("Province", "Area", "Freq")
ggplot(province_vs_area_df, aes(x = Province, y = Freq, fill = Area))+
geom_bar(stat="identity", position="dodge")+
labs(x = "Province",
y = "Number of women") +
scale_fill_manual(values = c("1" = "gray", "2" = "black"),
  labels = c("1" = "Urban", "2" = "Rural"))+
scale_x_discrete(
    labels = c(
    "1" = "Kabul",
    "2" = "Kapisa",
    "3" = "Parwan",
    "4" = "Maidan Wardak",
    "5" = "Logar",
    "6" = "Nangarhar",
    "7" = "Laghman",
    "8" = "Panjsher",
    "9" = "Baghlan",
    "10" = "Bamyan",
    "11" = "Ghazni",
    "12" = "Paktika",
    "13" = "Paktya",
    "14" = "Khost",
    "15" = "Kunarha",
    "16" = "Nooristan",
    "17" = "Badakhshan",
    "18" = "Takhar",
    "19" = "Kunduz",
    "20" = "Samangan",
    "21" = "Balkh",
    "22" = "Sar-e-Pul",
    "23" = "Ghor",
    "24" = "Daykundi",
    "25" = "Urozgan",
    "26" = "Zabul",
    "27" = "Kandahar",
    "28" = "Jawzjan",
    "29" = "Faryab",
    "30" = "Helmand",
    "31" = "Badghis",
    "32" = "Herat",
    "33" = "Farah",
    "34" = "Nimroz"
  )
)+
theme_minimal()+
theme(axis.text.x = element_text(angle = 45, hjust = 1))
dev.print(pdf,
	paste(IMAGEOUT,"NumOfRecords_ProvinceVsArea.pdf",sep=""),
	width=14,height=6)

province <- factor(province)
# Using Kandahar as the reference level for province
province <- relevel(province, ref = 32)
province <- model.matrix(~province, data = province)
colnames(province) <- c(
  "P.KANDAHAR.ref",
  "P.KABUL",
  "P.KAPISA",
  "P.PARWAN",
  "P.MAIDAN WARDAK",
  "P.LOGAR",
  "P.NANGARHAR",
  "P.LAGHMAN",
  "P.PANJSHER",
  "P.BAGHLAN",
  "P.BAMYAN",
  "P.GHAZNI",
  "P.PAKTIKA",
  "P.PAKTYA",
  "P.KHOST",
  "P.KUNARHA",
  "P.NOORISTAN",
  "P.BADAKHSHAN",
  "P.TAKHAR",
  "P.KUNDUZ",
  "P.SAMANGAN",
  "P.BALKH",
  "P.SAR-E-PUL",
  "P.GHOR",
  "P.DAYKUNDI",
  "P.UROZGAN",
  "P.ZABUL",
  "P.JAWZJAN",
  "P.FARYAB",
  "P.HELMAND",
  "P.BADGHIS",
  "P.HERAT",
  "P.FARAH",
  "P.NIMROZ"
)
########################province##############################

##########################area################################
area <- df_sel$area
area <- ifelse(area==2, "RURAL", "URBAN")
area <- factor(area)
area <- relevel(area, ref = "RURAL")
##########################area################################

###################husband has other wives####################
other_wives <- df_sel$other_wives
# remap, treat NA and 9(NO RESPONSE) the same as
# not having other wives
other_wives[is.na(other_wives)] <- 9
other_wives <- ifelse(other_wives > 1, 0, 1)
other_wives <- factor(other_wives)
# no need to relevel, reference level is 0 (no other wives)
# if you want to use 1 as reference level, set `ref=2`
# other_wives <- relevel(other_wives, ref = 1)
###################husband has other wives####################

###################household head sex#########################
# Remap, 0 for male; 1 for female
HH_sex <- case_when(
    df_sel$HH_sex == 2 ~ 1,
    df_sel$HH_sex == 1 ~ 0
)
HH_sex <- factor(HH_sex)
##############################################################


##############################################################
####################RANDOM VARIABLES##########################
##############################################################

   ########################################################
   #################Quantitative Variables#################
   ########################################################

####################women's age###############################
women_age <- df_sel$women_age
####################women's age###############################

####################women's age squared#######################
women_age2 <- women_age^2
####################women's age squared#######################

###################household head's age#######################
HH_age <- df_sel$HH_age
###################household head's age#######################

###################household head's age squared###############
HH_age2 <- HH_age^2
###################household head's age squared###############

###############women's age at marriage#########################
women_agem <- df_sel$women_agem
###############women's age at marriage#########################

   ########################################################
   #################Categorical  Variables#################
   ########################################################

####################women's edu level#########################
women_edu <- df_sel$women_edu
# `women_edu` comes from column `WB6A` which give the
# Highest level of edu level. So if a woman does not
# have any education, there will be a NA here.
# In fact, we have another column `welevel` on women's education,
# and the two columns give the same infomation.
# We can double check by comparing those two columns:
# View(cbind(wm$welevel,wm$WB6A))
# women that didnt go to school are going to have a 0 here
women_edu[is.na(women_edu)] <- 0
# remap class 5 (FORMAL ISLAMIC EDUCATION) to 0
women_edu <- ifelse(women_edu == 5, 0, women_edu)
# make it binary: 0 (for no education), 1 (has some education)
women_edu <- ifelse(women_edu > 0, 1, 0)
women_edu <- factor(women_edu)
####################women's edu level#########################

###################household Head's edu level#################
HH_edu <- df_sel$HH_edu
# remap class 9 (DK/MISSING) to 0
HH_edu <- ifelse(HH_edu == 9, 0, HH_edu)
# make it binary: 0 (no education), 1 (has some education)
HH_edu <- ifelse(HH_edu > 0, 1, 0)
HH_edu <- factor(HH_edu)
###################household Head's edu level#################

###################wealth index (3 classes)###################
table(df_sel$windex5, useNA="ifany")
# combine the lower 2 levels as well as the higher 2 levels
windex3 <- case_when(
    df_sel$windex5 %in% c(1, 2) ~ 1,
    df_sel$windex5 == 3 ~ 2,
    df_sel$windex5 %in% c(4, 5) ~ 3
)
windex3 <- factor(windex3)
# we use the middle class as the reference level
windex3 <- relevel(windex3, ref=2)

windex3 <- model.matrix(~windex3, data = windex3)
colnames(windex3) <- c(
  "windex3.Middle.ref",
  "windex3.Poor",
  "windex3.Rich"
)
###################wealth index (3 classes)###################

########################media access##########################
media <- df_sel$media_tv + df_sel$media_radio
media <- ifelse(media >= 1, 1, 0)
media <- factor(media)
########################media access##########################
```

# Bayesian Weighted Poisson Regression Model
## Utility functions and data
```{r}
#######################utility functions######################
## mvnormal simulation
rmvnorm<-function(n,mu,Sigma)
{
  E<-matrix(rnorm(n*length(mu)),n,length(mu))
  t(  t(E%*%chol(Sigma)) +c(mu))
}

## Wishart simulation
rwish<-function(n,nu0,S0)
{
  sS0 <- chol(S0)
  S<-array( dim=c( dim(S0),n ) )
  for(i in 1:n)
  {
     Z <- matrix(rnorm(nu0 * dim(S0)[1]), nu0, dim(S0)[1]) %*% sS0
     S[,,i]<- t(Z)%*%Z
  }
  S[,,1:n]
}
## mvnorm log density
ldmvnorm<-function(X,mu,Sigma,iSigma=solve(Sigma),dSigma=det(Sigma))
{
  Y<-t( t(X)-mu)
  sum(diag(-.5*t(Y)%*%Y%*%iSigma))  -
  .5*(  prod(dim(X))*log(2*pi) +     dim(X)[1]*log(dSigma) )
}
## Calculate matrix multiplication: (1,Z) %*% Beta
matmul <- function(Z, Beta){
nZ <- nrow(Z)
as.matrix(cbind(rep(1,nZ),Z))%*%as.matrix(Beta)
}
#######################utility functions######################

#######################design matrix##########################
# Design matrix for all varables (random x10 | fixed x36)
X <- as.matrix(cbind(
	### random predictors
  women_age,
  women_age2,
  HH_age,
  HH_age2,
  women_agem,
  women_edu,
  HH_edu,
  windex3[,-1],
  media,
	### fixed predictor
  province[,-1],# 33
  area,
  other_wives,
  HH_sex
))

# Concat response variable y with design matrix of X
yX <- cbind(y,X)
#######################design matrix##########################
```

## Init

```{r}
#######################initial values#########################
p<-dim(X)[2] + 1# number of columns in X (10+36) + 1 (intercept)

# The initial mean of the MVN prior of theta
model <- glm(y~., data = data.frame(yX), family=poisson)
THETA <- mu0 <- model$coefficients

# The initial variance of the MVN prior for the variance of theta
# LAMBDA is the inverse of Fisher information matrix
LAMBDA <- vcov(model)

# The accepted count of proposed theta
ACCEPT.Theta.count <- 0
SIGMA.post<-NULL
THETA.post <- list()
S=220000
B=20000
thin=50
#######################initial values#########################
```

Laplace Prior
Setup a same variance for all predictors
```{r}
library(extraDistr)
pmn.theta <- rep(0,p)

s <- seq(0.00001, 6, by = 0.00001)
for(i in 1:length(s)){
  quant <- qlaplace(0.975, mu = 0, sigma = s[i])
  if(quant > 6){
    cat("q = ", quant, "\n")
    cat("sd = ", s[i], "\n")
    break
  }
}
psd.theta <- NULL
psd.theta[1] <- s[i]
plaplace(6, mu= 0, sigma = s[i])

for(i in 1:length(s)){
  quant <- qlaplace(0.975, mu = 0, sigma = s[i])
  if(quant > 0.5){
    cat("q = ", quant, "\n")
    cat("sd = ", s[i], "\n")
    break
  }
}
psd.theta[c(2:p)] <- s[i]
plaplace(0.5, mu= 0, sigma = s[i])
```
## Simulation

```{r eval=FALSE}
#######################simulation#############################
set.seed(123)
start.time <- Sys.time()
for(s in 1:S)
{
	##update theta
	# theta proposed
	K_theta <- 0.05
	theta.p<-t(rmvnorm(1,THETA,K_theta*LAMBDA))
	lr<-0
	lr <- lr+sum(
		wgt * dpois(y,
			lambda=exp(matmul(X,theta.p)),log=TRUE),
		-wgt * dpois(y,
			lambda=exp(matmul(X,THETA)),log=TRUE),
		sum( dlaplace(theta.p, pmn.theta, psd.theta, log=T)),
		-sum(dlaplace(THETA, pmn.theta, psd.theta, log=T))
	)
	#print("lr is")
	#print(lr)
	if( log(runif(1))<lr ) {
		ACCEPT.Theta.count<- ACCEPT.Theta.count+1
		THETA<-theta.p
	}

	##store some output
	if((s %% thin == 0) & (s > B)) # saving every 10th value
	{
		cat("Current iteration index = ", s, "\n")
		# Print current acceptance rate
		cat("Current acceptance rate of Theta = ", round((ACCEPT.Theta.count/s)*100, digits = 2),"\n")
		# save thinned coefficients
		THETA.post<-rbind(THETA.post,t(THETA))
	}
}
end.time <- Sys.time()
#######################simulation#############################
```

## Save and load results

```{r eval=FALSE}
save(THETA.post, file="data_output/sim/LaplacePrior/FE.THETA.post.S=220000.RData")
save(ACCEPT.Theta.count, file="data_output/sim/LaplacePrior/FE.ACCEPT.Theta.count.S=220000.RData")
```

```{r eval=TRUE}
load("data_output/sim/LaplacePrior/FE.THETA.post.S=220000.RData")
load("data_output/sim/LaplacePrior/FE.ACCEPT.Theta.count.S=220000.RData")
```

# Plot results

## Assess the convergence of the Markov chain

```{r}
## stationarity plot - boxplot
stationarity.plot<-function(x,...){
S<-length(x)
scan<-1:S
ng<-min( round(S/100),10)
group<-S*ceiling( ng*scan/S) /ng
boxplot(x~group,...)
}
```

```{r}
# convert the result into a 47x(S-B) matrix
THETA.post.mat <- NULL
for (i in c(1:dim(THETA.post)[1])){
THETA.post.mat <- cbind(THETA.post.mat, as.matrix(unlist(t(THETA.post)[,i])) )
}

#stationarity.plot(THETA.post[, 1],xlab="iteration",ylab=expression(theta[11]))
par(mfrow = c(8, 6), mar=c(3,2,1,1),mgp=c(2,1,0))
for (i in 1:p) {
plot(seq(1,(S-B)/thin,by=1), THETA.post[,i], type = "l", xlab = "Iterations", ylab = expression(theta), main=i)
}
dev.print(pdf,
	paste(IMAGEOUT,"FE.THETA.post.pdf",sep=""),
	width=16,height=12)

library(coda)
par(mfrow = c(8, 6), mar=c(3,2,1,1),mgp=c(2,1,0))
for (i in 1:p){
esize <- effectiveSize(unlist(THETA.post[,i]))
acf_plot <- acf(unlist(THETA.post[,i]), plot = FALSE)
t <- paste(i,",Effective Size: ", esize, sep="")
plot(acf_plot, xlab=t, ylab="", main=t)
}
dev.print(pdf,
	paste(IMAGEOUT,"FE.ACF.THETA.post.pdf",sep=""),
	width=16,height=12)
```

### Posterior estimates with 95% credible intervals (CI) of the incidence rate ratio (IRR) for the explanatory variables

```{r}
library(xtable)
CI_THETA <- round(t(apply(exp(THETA.post.mat), 1, quantile ,probs=c(0.50, 0.025, 0.975))), digits = 5)
CI_THETA
xtable(CI_THETA, digits = 3)
```

## Calculate the expected number of CEB

### Expected Children Ever Born - Woman's age

```{r}
#CItheta <- apply(THETA.post, MARGIN=2, function(q){return(quantile(unlist(q),prob=c(0.025,0.5,0.975)))})
Xs <- apply(X, 2, mean)
Xs[4] <- Xs[3]^2
Xs <- matrix(rep(Xs, 35), nrow = 35, byrow = T)
Xs[,1] <- seq(15, 49, by = 1)
Xs[,2] <- (seq(15, 49, by = 1)^2)
colnames(Xs) <- colnames(X)
Xs = cbind(rep(1,35),Xs) # insert the first column of 1 for intercept
eXB.post <- exp(Xs%*%THETA.post.mat)
qE<-apply(t(eXB.post),2,quantile,probs=c(.025,.5,.975))

par(mar=c(4,4.5,1,1),mgp=c(1.88,0.50,0))
plot( c(15, 49),range(c(0,qE)),type="n",xlab="Woman's age",ylim=c(0,8),
      ylab="Expected number of children ever born", cex.lab = 2.5, cex.axis = 1.5)
lines(seq(15, 49, by = 1), qE[1,],col="black",lwd=0.5)
lines(seq(15, 49, by = 1), qE[2,],col="black",lwd=1.0)
lines(seq(15, 49, by = 1), qE[3,],col="black",lwd=0.5)
dev.print(pdf,
	paste(IMAGEOUT,"FE.E_women_age.pdf",sep=""),
	width=16,height=12)
```

### Expected Children Ever Born - Household Head's age

```{r}
Xs <- apply(X, 2, mean)
Xs[2] <- Xs[1]^2
Xs <- matrix(rep(Xs, 85), nrow = 85, byrow = T)
Xs[,3] <- seq(11, 95, by = 1)
Xs[,4] <- (seq(11, 95, by = 1)^2)
colnames(Xs) <- colnames(X)
Xs = cbind(rep(1,85),Xs) # insert the first column of 1 for intercept
eXB.post <- exp(Xs%*%THETA.post.mat)
qE<-apply(t(eXB.post),2,quantile,probs=c(.025,.5,.975))

par(mar=c(4,4.5,1,1),mgp=c(1.88,0.50,0))
plot( c(11, 95),range(c(0,qE)),type="n",xlab="Household head's age",ylim=c(0,8),
      ylab="Expected number of children ever born", cex.lab = 2.5, cex.axis = 1.5)
lines(seq(11, 95, by = 1), qE[1,],col="black",lwd=0.5)
lines(seq(11, 95, by = 1), qE[2,],col="black",lwd=1.0)
lines(seq(11, 95, by = 1), qE[3,],col="black",lwd=0.5)
dev.print(pdf,
	paste(IMAGEOUT,"FE.E_HH_age.pdf",sep=""),
	width=16,height=12)
```

### Expected Children Ever Born - Woman's age at marriage

```{r}
Xs <- apply(X, 2, mean)
Xs[2]<- Xs[1]^2
Xs <- matrix(rep(Xs, 40), nrow = 40, byrow = T)
Xs[,5] <- seq(9, 48, by = 1)
colnames(Xs) <- colnames(X)
Xs = cbind(rep(1,40),Xs)
eXB.post <- exp(Xs%*%THETA.post.mat)
qE<-apply(t(eXB.post),2,quantile,probs=c(.025,.5,.975))

colnames(qE)<-as.character(9:48)
write.csv(t(qE), paste(IMAGEOUT,"qE.women_agem.FE.csv",sep=""))

par(mar=c(4,4.5,1,1),mgp=c(1.88,0.50,0))
plot( c(9, 48),range(c(0,qE)),type="n",xlab="Woman's age at marriage",ylim=c(0,8),
      ylab="Expected number of children ever born", cex.lab = 2.5, cex.axis = 1.5)
lines(seq(9, 48, by = 1), qE[1,],col="black",lwd=0.5)
lines(seq(9, 48, by = 1), qE[2,],col="black",lwd=1.0)
lines(seq(9, 48, by = 1), qE[3,],col="black",lwd=0.5)
dev.print(pdf,
	paste(IMAGEOUT,"FE.E_women_agem.pdf",sep=""),
	width=16,height=12)
```

### Expected Children Ever Born - Provinces

```{r}
# Expected Number of Children Ever Born in Afghanistan
Xs <- apply(X, 2, mean)
Xs[2] <- Xs[1]^2
Xs[4] <- Xs[3]^2
Xs <- as.matrix(c(1, Xs))
eXB.post<- exp(t(t(Xs)%*%THETA.post.mat) )
qEA<-apply( eXB.post,2,quantile,probs=c(.025,.5,.975))
round(qEA, digits = 3)
# Provinces

dnames <- c(
"Afghanistan",
"Herat",
"Kabul",
"Kapisa",
"Parwan",
"Maidan Wardak",
"Logar",
"Nangarhar",
"Laghman",
"Panjsher",
"Baghlan",
"Bamyan",
"Ghazni",
"Paktika",
"Paktya",
"Khost",
"Kunarha",
"Nooristan",
"Badakhshan",
"Takhar",
"Kunduz",
"Samangan",
"Balkh",
"Sar-e-Pul",
"Ghor",
"Daykundi",
"Urozgan",
"Zabul",
"Kandahar",
"Jawzjan",
"Faryab",
"Helmand",
"Badghis",
"Farah",
"Nimroz")
index <- order(dnames)

Xs <- apply(X, 2, mean)
Xs[2] <- Xs[1]^2
Xs[4] <- Xs[3]^2
Xs <- matrix(rep(Xs, 34), nrow = 34, byrow = T)
for (prov_index in c(2:34)){
	x <- rep(0,34)
	x[prov_index] <- 1
	Xs[,(9+prov_index)] <- x
}
colnames(Xs) <- colnames(X)
Xs = cbind(rep(1,34),Xs)

eXB.post<- exp(t(Xs%*%THETA.post.mat) )
qE<-apply( eXB.post,2,quantile,probs=c(.025,.5,.975))

qE.out <- cbind(qEA,qE)
colnames(qE.out)<-dnames
write.csv(t(qE.out), paste(IMAGEOUT,"qE.province.FE.csv",sep=""))

index <- order(c(qEA[2,], qE[2,])[-1])
index <- c(1, index + 1)

library(ggplot2)
df <- data.frame(x =1:35,
                 F = c(qEA[2,], qE[2,])[index],
                 L = c(qEA[1,], qE[1,])[index],
                 U = c(qEA[3,], qE[3,])[index],
              name = dnames[index])
abc <- ggplot(df, aes(x = x, y = F)) +
  labs(y = "Expected number of children ever born", x = "Province") +
  ylim(3.5,5.7) +
  geom_point(size = 2) +
  geom_errorbar(aes(ymax = U, ymin = L)) +
  scale_x_continuous(breaks = c(1:35), labels = dnames[index]) +
  theme(axis.title=element_text(size=18), axis.text.x = element_text(size = 18, color = "black", angle = 45, vjust = 1, hjust = 1),
        axis.ticks.x = element_line(color = "black", linewidth = 1),
        axis.text.y = element_text(size = 18, color = "black"),
        axis.ticks.y = element_line(color = "black", linewidth = 1))
print(abc)
#dev.print(device = postscript, paste(IMAGEOUT, "E_province.eps",sep=""),width=8,height=8, horizontal = FALSE)
dev.print(pdf, paste(IMAGEOUT, "FE.E_province.pdf",sep=""),width=16,height=8)
```

```{r}
library(ggplot2)
library(sf)

map <- read_sf("data_src/map.json")
eCEB <- NULL
for (n in map$name){
	print(n)
	print(which(df$name==n))
	print(df$name[which(df$name==n)])
	print(df$F[which(df$name==n)])
	eCEB <- append(eCEB, df$F[which(df$name==n)])
}
map$eCEB <- eCEB
ggplot(map) +
	geom_sf(aes(fill = eCEB)) +
	scale_fill_gradient(low="#56B1F7", high="#132B43") +
	theme(
  legend.title = element_text(size = 20),     # Legend title size
  legend.text = element_text(size = 20)       # Legend item text size
)+
	geom_sf_label(aes(label = name), size = 3) +
	labs(fill="eCEB", x="latitude", y="longtitude") +
	theme(
  legend.title = element_text(size = 30),     # Legend title size
  legend.text = element_text(size = 30),       # Legend item text size
	axis.title = element_text(size = 30),
	axis.text = element_text(size = 20)
)
dev.print(pdf, paste(IMAGEOUT, "FE.E_province_map.pdf",sep=""),width=16,height=16)
```

Expected Children Ever Born - Wealth Index

```{r}
winames <- c("Middle", "Poor", "Rich")
index <- c(2, 1, 3)
winames[index]

Xs <- apply(X, 2, mean)
Xs[2] <- Xs[1]^2
Xs[4] <- Xs[3]^2
Xs <- as.matrix(c(1, Xs))
Xs <- matrix(rep(Xs, 3), nrow = 3, byrow = T)
Xs[,9] <- c(0, 1, 0)
Xs[,10] <- c(0, 0, 1)

eXB.post<- exp(t(Xs%*%THETA.post.mat) )
qE<-apply( eXB.post,2,quantile,probs=c(.025,.5,.975))

colnames(qE)<-winames
write.csv(t(qE), paste(IMAGEOUT,"qE.windex.FE.csv",sep=""))

df <- data.frame(x =1:3,
                 F = c(qE[2,])[index],
                 L = c(qE[1,])[index],
                 U = c(qE[3,])[index])
abc <- ggplot(df, aes(x = x, y = F)) +
  labs(y = "Expected number of children ever born", x = "Wealth", cex.lab = 2.5, cex.axis = 1.5) +
  geom_point(size = 2) +
  ylim(4.2,4.75) +
  geom_errorbar(aes(ymax = U, ymin = L)) +
  scale_x_continuous(breaks = c(1:3), labels = winames[index]) +
  theme(axis.title=element_text(size=18), axis.text.x = element_text(size = 18, color = "black", angle = 45, vjust = 1, hjust = 1),
        axis.ticks.x = element_line(color = "black", linewidth = 1),
        axis.text.y = element_text(size = 18, color = "black"),
        axis.ticks.y = element_line(color = "black", linewidth = 1))
print(abc)

dev.print(pdf, paste(IMAGEOUT, "FE.E_windex3.pdf",sep=""),width=8,height=8)
```

Expected Children Ever Born - Area

```{r}
# To check the X value for area, 2 for Urban, 1 for Rural
# (it is flipped because of refactor)
# unique(as.numeric(area)-X[,44])

anames<- c("Rural", "Urban")
index <- c(1, 2)
anames[index]

Xs <- apply(X, 2, mean)
Xs[2] <- Xs[1]^2
Xs[4] <- Xs[3]^2
Xs <- as.matrix(c(1, Xs))
Xs <- matrix(rep(Xs, 2), nrow = 2, byrow = T)
Xs[,45] <- c(1, 2) # 2 for Urban, 1 for Rural

eXB.post<- exp(t(Xs%*%THETA.post.mat) )
qE<-apply( eXB.post,2,quantile,probs=c(.025,.5,.975))

colnames(qE)<-anames
write.csv(t(qE), paste(IMAGEOUT,"qE.area.FE.csv",sep=""))

df <- data.frame(x =1:2,
                 F = c(qE[2,])[index],
                 L = c(qE[1,])[index],
                 U = c(qE[3,])[index])
abc <- ggplot(df, aes(x = x, y = F)) +
  labs(y = "Expected number of children ever born", x = "Area") +
  geom_point(size = 2) +
  ylim(4.4,4.6) +
  geom_errorbar(aes(ymax = U, ymin = L)) +
  scale_x_continuous(breaks = c(1:2), labels = anames[index]) +
  theme(axis.title=element_text(size=18), axis.text.x = element_text(size = 18, color = "black", angle = 45, vjust = 1, hjust = 1),
        axis.ticks.x = element_line(color = "black", linewidth = 1),
        axis.text.y = element_text(size = 18, color = "black"),
        axis.ticks.y = element_line(color = "black", linewidth = 1))
print(abc)

dev.print(pdf, paste(IMAGEOUT, "FE.E_area.pdf",sep=""),width=8,height=8)
(qE[2,][1] - qE[2,][2])/qE[2,][2]
```

Expected Children Ever Born - Have other wives

```{r}
otherwives_labels <- c("No", "Yes")
index <- c(1, 2)
otherwives_labels[index]

Xs <- apply(X, 2, mean)
Xs[2] <- Xs[1]^2
Xs[4] <- Xs[3]^2
Xs <- as.matrix(c(1, Xs))
Xs <- matrix(rep(Xs, 2), nrow = 2, byrow = T)
Xs[,46] <- c(1, 2) # 1 for No other wives, 2 for one or more

eXB.post<- exp(t(Xs%*%THETA.post.mat) )
qE<-apply( eXB.post,2,quantile,probs=c(.025,.5,.975))

colnames(qE)<-otherwives_labels
write.csv(t(qE), paste(IMAGEOUT,"qE.other_wives.FE.csv",sep=""))

df <- data.frame(x =1:2,
                 F = c(qE[2,])[index],
                 L = c(qE[1,])[index],
                 U = c(qE[3,])[index])
abc <- ggplot(df, aes(x = x, y = F)) +
  labs(y = "Expected number of children ever born", x = "Having other wives") +
  geom_point(size = 2) +
  ylim(3.75,4.75) +
  geom_errorbar(aes(ymax = U, ymin = L)) +
  scale_x_continuous(breaks = c(1:2), labels = otherwives_labels[index]) +
  theme(axis.title=element_text(size=18), axis.text.x = element_text(size = 18, color = "black", angle = 45, vjust = 1, hjust = 1),
        axis.ticks.x = element_line(color = "black", linewidth = 1),
        axis.text.y = element_text(size = 18, color = "black"),
        axis.ticks.y = element_line(color = "black", linewidth = 1))
print(abc)

dev.print(pdf, paste(IMAGEOUT, "FE.E_other_wives.pdf",sep=""),width=8,height=8)
(qE[2,][1] - qE[2,][2])/qE[2,][2]
```

Expected Children Ever Born - Household Head sex

```{r}
HH_sex_labels <- c("Male", "Female")
index <- c(1, 2)
HH_sex_labels[index]

Xs <- apply(X, 2, mean)
Xs[2] <- Xs[1]^2
Xs[4] <- Xs[3]^2
Xs <- as.matrix(c(1, Xs))
Xs <- matrix(rep(Xs, 2), nrow = 2, byrow = T)
Xs[,47] <- c(1, 2) # 1 for Male, 2 for Female

eXB.post<- exp(t(Xs%*%THETA.post.mat) )
qE<-apply( eXB.post,2,quantile,probs=c(.025,.5,.975))

colnames(qE)<-HH_sex_labels
write.csv(t(qE), paste(IMAGEOUT,"qE.HH_sex.FE.csv",sep=""))

df <- data.frame(x =1:2,
                 F = c(qE[2,])[index],
                 L = c(qE[1,])[index],
                 U = c(qE[3,])[index])
abc <- ggplot(df, aes(x = x, y = F)) +
  labs(y = "Expected number of children ever born", x = "Household head's sex") +
  geom_point(size = 2) +
  ylim(4,4.6) +
  geom_errorbar(aes(ymax = U, ymin = L)) +
  scale_x_continuous(breaks = c(1:2), labels = HH_sex_labels[index]) +
  theme(axis.title=element_text(size=18), axis.text.x = element_text(size = 18, color = "black", angle = 45, vjust = 1, hjust = 1),
        axis.ticks.x = element_line(color = "black", linewidth = 1),
        axis.text.y = element_text(size = 18, color = "black"),
        axis.ticks.y = element_line(color = "black", linewidth = 1))
print(abc)

dev.print(pdf, paste(IMAGEOUT, "FE.E_HH_sex.pdf",sep=""),width=8,height=8)
```

Expected Children Ever Born - Media exposure

```{r}
media_labels <- c("No", "Yes")
index <- c(1, 2)
media_labels[index]

Xs <- apply(X, 2, mean)
Xs[2] <- Xs[1]^2
Xs[4] <- Xs[3]^2
Xs <- as.matrix(c(1, Xs))
Xs <- matrix(rep(Xs, 2), nrow = 2, byrow = T)
Xs[,11] <- c(1, 2) # 1 for No, 2 for Yes

eXB.post<- exp(t(Xs%*%THETA.post.mat) )
qE<-apply( eXB.post,2,quantile,probs=c(.025,.5,.975))

colnames(qE)<-media_labels
write.csv(t(qE), paste(IMAGEOUT,"qE.media.FE.csv",sep=""))

df <- data.frame(x =1:2,
                 F = c(qE[2,])[index],
                 L = c(qE[1,])[index],
                 U = c(qE[3,])[index])
abc <- ggplot(df, aes(x = x, y = F)) +
  labs(y = "Expected number of children ever born", x = "Media access") +
  geom_point(size = 2) +
  ylim(4.2,4.8) +
  geom_errorbar(aes(ymax = U, ymin = L)) +
  scale_x_continuous(breaks = c(1:2), labels = media_labels[index]) +
  theme(axis.title=element_text(size=18), axis.text.x = element_text(size = 18, color = "black", angle = 45, vjust = 1, hjust = 1),
        axis.ticks.x = element_line(color = "black", linewidth = 1),
        axis.text.y = element_text(size = 18, color = "black"),
        axis.ticks.y = element_line(color = "black", linewidth = 1))
print(abc)

dev.print(pdf, paste(IMAGEOUT, "FE.E_media.pdf",sep=""),width=8,height=8)
```

Expected Children Ever Born - Woman's education

```{r}
women_edu_labels <- c("No", "Yes")
index <- c(1, 2)
women_edu[index]

Xs <- apply(X, 2, mean)
Xs[2] <- Xs[1]^2
Xs[4] <- Xs[3]^2
Xs <- as.matrix(c(1, Xs))
Xs <- matrix(rep(Xs, 2), nrow = 2, byrow = T)
Xs[,7] <- c(1, 2) # 1 for No, 2 for Yes

eXB.post<- exp(t(Xs%*%THETA.post.mat) )
qE<-apply( eXB.post,2,quantile,probs=c(.025,.5,.975))

colnames(qE)<-women_edu_labels
write.csv(t(qE), paste(IMAGEOUT,"qE.women_edu.FE.csv",sep=""))

df <- data.frame(x =1:2,
                 F = c(qE[2,])[index],
                 L = c(qE[1,])[index],
                 U = c(qE[3,])[index])
abc <- ggplot(df, aes(x = x, y = F)) +
  labs(y = "Expected number of children ever born", x = "Women's education") +
  geom_point(size = 2) +
  ylim(4.1,4.7) +
  geom_errorbar(aes(ymax = U, ymin = L)) +
  scale_x_continuous(breaks = c(1:2), labels = women_edu_labels[index]) +
  theme(axis.title=element_text(size=18), axis.text.x = element_text(size = 18, color = "black", angle = 45, vjust = 1, hjust = 1),
        axis.ticks.x = element_line(color = "black", linewidth = 1),
        axis.text.y = element_text(size = 18, color = "black"),
        axis.ticks.y = element_line(color = "black", linewidth = 1))
print(abc)

dev.print(pdf, paste(IMAGEOUT, "FE.E_women_edu.pdf",sep=""),width=8,height=8)
```

Expected Children Ever Born - Household Head's education

```{r}
HH_edu_labels <- c("No", "Yes")
index <- c(1, 2)
HH_edu_labels[index]

Xs <- apply(X, 2, mean)
Xs[2] <- Xs[1]^2
Xs[4] <- Xs[3]^2
Xs <- as.matrix(c(1, Xs))
Xs <- matrix(rep(Xs, 2), nrow = 2, byrow = T)
Xs[,8] <- c(1, 2) # 1 for No, 2 for Yes

eXB.post<- exp(t(Xs%*%THETA.post.mat) )
qE<-apply( eXB.post,2,quantile,probs=c(.025,.5,.975))

colnames(qE)<-HH_edu_labels
write.csv(t(qE), paste(IMAGEOUT,"qE.HH_edu.FE.csv",sep=""))

df <- data.frame(x =1:2,
                 F = c(qE[2,])[index],
                 L = c(qE[1,])[index],
                 U = c(qE[3,])[index])
abc <- ggplot(df, aes(x = x, y = F)) +
  labs(y = "Expected number of children ever born", x = "Household head's education") +
  geom_point(size = 2) +
  ylim(4.4,4.6)+
  geom_errorbar(aes(ymax = U, ymin = L)) +
  scale_x_continuous(breaks = c(1:2), labels = women_edu_labels[index]) +
  theme(axis.title=element_text(size=18), axis.text.x = element_text(size = 18, color = "black", angle = 45, vjust = 1, hjust = 1),
        axis.ticks.x = element_line(color = "black", linewidth = 1),
        axis.text.y = element_text(size = 18, color = "black"),
        axis.ticks.y = element_line(color = "black", linewidth = 1))
print(abc)

dev.print(pdf, paste(IMAGEOUT, "FE.E_HH_edu.pdf",sep=""),width=8,height=8)
```


## Dispersion Test

```{r}
fit.mle <- glm(y~., data = data.frame(yX), family=poisson)
library(AER)
dispersiontest(fit.mle, alternative = "less")
```

```{r}
# Calculation of BIC (Weighted)
n<-length(y)
BIC_W <- p * log(n) - 2 * sum(wgt*dpois(y,exp(matmul(X,as.matrix(apply(THETA.post.mat, 1, mean)))),log=T))
print(BIC_W)
```
